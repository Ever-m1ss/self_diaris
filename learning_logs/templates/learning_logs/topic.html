{% extends 'learning_logs/base.html' %}
{% load static %}

{% block page_back_button %}
  <div class="page-back-container mb-2">
    <a class="back-btn" href="{% url 'learning_logs:index' %}" aria-label="返回">
      <img src="{% static 'img/icons/arrow-left.svg' %}" alt="返回" />
    </a>
  </div>
{% endblock %}

{% block page_header %}
  <div class="topic-header-glass d-flex justify-content-between align-items-center">
    <h1 class="mb-0 topic-title">{{ topic.text }}
      {% if topic.is_public %}
        <span class="badge text-bg-success align-middle" style="font-size: .45em;">公开</span>
      {% else %}
        <span class="badge text-bg-secondary align-middle" style="font-size: .45em;">私密</span>
      {% endif %}
    </h1>
    <div class="d-flex gap-2 flex-shrink-0 topic-actions">
      {% if topic.is_public or topic.owner == user %}
        <a href="{% url 'learning_logs:new_entry' topic.id %}" class="btn btn-primary">写一篇日记</a>
      {% endif %}
      {% if topic.owner == user %}
        <a href="{% url 'learning_logs:delete_topic' topic.text %}" class="btn btn-outline-danger">删除日记本</a>
      {% endif %}
    </div>
  </div>
{% endblock page_header %}

{% block content %}

  {# 日记本附件（统一 GitHub 风格 + 异步上传） #}
  <div class="card mb-3">
    <div class="card-body">
      <h6 class="mb-2">日记本附件</h6>
      <div class="ll-attachments" data-parent-type="topic" data-parent-id="{{ topic.id }}"{% if user == topic.owner %} data-can-edit="1"{% endif %}>
        <div class="list-group list-group-flush ll-attach-list">
          {% include 'learning_logs/_attachment_tree.html' with tree=topic.attachment_tree parent_owner=topic.owner base='' allow_modify=True allow_download=True %}
        </div>
        {% if user == topic.owner %}
          <div class="mt-2 d-flex gap-2 flex-wrap">
            <label class="btn btn-outline-primary btn-sm mb-0">
              选择文件
              <input class="d-none" type="file" multiple>
            </label>
            <label class="btn btn-outline-primary btn-sm mb-0">
              选择文件夹
              <input class="d-none" type="file" multiple webkitdirectory directory>
            </label>
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  {% for entry in entries %}
    <div class="card mb-3">
      <!-- Card header with timestamp and edit link -->
      <h4 class="card-header d-flex justify-content-between align-items-center">
        <span>
          发布于 {{ entry.date_added|date:'Y-m-d H:i' }}
          {% if entry.last_edited and entry.last_edited != entry.date_added %} · 最后编辑于 {{ entry.last_edited|date:'Y-m-d H:i' }}{% endif %}
          {% if entry.owner == user %}
            <a href="{% url 'learning_logs:edit_entry' entry.id %}" class="btn btn-sm btn-outline-primary ms-2">编辑日记</a>
          {% endif %}
        </span>
        <span>
          {% if entry.is_public %}
            <span class="badge text-bg-success">公开</span>
          {% else %}
            <span class="badge text-bg-secondary">私密</span>
          {% endif %}
        </span>
      </h4>
      <!-- Card body with entry text -->
      <div class="card-body">
        {{ entry.text|linebreaks }}

        {# 附件：紧随正文显示 #}
        {% with attachments=entry.attachment_set.all attachment_tree=entry.attachment_tree %}
          <hr>
          <h6 class="mb-2">附件</h6>
          <div class="ll-attachments" data-parent-type="entry" data-parent-id="{{ entry.id }}">
            <div class="list-group list-group-flush ll-attach-list">
              {% include 'learning_logs/_attachment_tree.html' with tree=attachment_tree parent_owner=entry.owner base='' allow_modify=False allow_download=True %}
            </div>
          </div>
        {% endwith %}

        {% if entry.is_public or entry.owner == user %}
          <hr>
          <h6 class="mb-2">评论</h6>
          <div class="mb-3">
            {% with top_comments=entry.top_comments %}
                {% if top_comments.exists %}
                  <div class="list-group list-group-flush">
                    {% for c in top_comments %}
                    <div class="list-group-item comment-item" data-id="{{ c.id }}">
                      <div class="d-flex justify-content-between align-items-center mb-1">
                        <div class="fw-semibold">{{ c.display_name }}</div>
                        <div class="small text-muted">{{ c.date_added|date:'Y-m-d H:i' }}</div>
                      </div>
                      {% if c.text %}
                        <div class="mb-1">{{ c.text|linebreaks }}</div>
                      {% endif %}
                      {% with tree=c.attachment_tree parent_owner=entry.owner %}
                        {% if tree.files or tree.dirs %}
                          <div class="mt-1">
                            <div class="ll-attachments" data-parent-type="comment" data-parent-id="{{ c.id }}" {% if c.allow_modify %}data-can-edit="1"{% endif %}>
                              <div class="list-group list-group-flush ll-attach-list">
                                {% include 'learning_logs/_attachment_tree.html' with tree=tree parent_owner=entry.owner base='' allow_modify=c.allow_modify allow_download=True %}
                              </div>
                            </div>
                          </div>
                        {% endif %}
                      {% endwith %}

                      <div class="mt-2 d-flex gap-2">
                        <button type="button" class="btn btn-sm btn-outline-secondary btn-reply" data-comment-id="{{ c.id }}">回复</button>
                        {% if c.user == user %}
                          <button type="button" class="btn btn-sm btn-outline-danger delete-comment ms-2" data-id="{{ c.id }}">删除</button>
                        {% endif %}
                        {% if c.replies.exists %}
                          <button type="button" class="btn btn-sm btn-link ms-auto btn-toggle-replies" data-target="#replies-{{ c.id }}">展开回复 ({{ c.replies.count }})</button>
                        {% endif %}
                      </div>

                      {# 折叠的直接回复列表（仅顶级评论的直接回复显示为折叠列表） #}
                      {% if c.replies.exists %}
                        <div id="replies-{{ c.id }}" class="mt-2 ms-3 d-none">
                          <div class="list-group list-group-flush">
                            {% for r in c.replies.all %}
                              <div class="list-group-item">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                  <div class="fw-semibold">{{ r.display_name }}</div>
                                  <div class="small text-muted">{{ r.date_added|date:'Y-m-d H:i' }}</div>
                                </div>
                                {% if r.text %}
                                  <div class="mb-1">{{ r.text|linebreaks }}</div>
                                {% endif %}
                                {% if r.user == user %}
                                  <div class="mt-1 text-end">
                                    <button type="button" class="btn btn-sm btn-outline-danger delete-comment" data-id="{{ r.id }}">删除</button>
                                  </div>
                                {% endif %}
                                {# 如果该回复还有更深层次的回复，将以 @username 行内形式显示 #}
                                {% if r.replies.exists %}
                                  <div class="small text-muted mt-1">
                                    {% for rr in r.replies.all %}
                                      <div>
                                        @{{ rr.display_name }}: {{ rr.text|truncatechars:120 }}
                                        {% if rr.user == user %}
                                          <button type="button" class="btn btn-sm btn-link text-danger delete-comment" data-id="{{ rr.id }}">删除</button>
                                        {% endif %}
                                      </div>
                                    {% endfor %}
                                  </div>
                                {% endif %}
                              </div>
                            {% endfor %}
                          </div>
                        </div>
                      {% endif %}

                      {# 回复表单（隐藏，点击 回复 按钮显示） #}
                      <div class="reply-form mt-2 d-none">
                        <form action="{% url 'learning_logs:add_comment' entry.id %}" method="post" class="d-flex gap-2 align-items-start">
                          {% csrf_token %}
                          <input type="hidden" name="parent_id" value="{{ c.id }}">
                          <div class="flex-grow-1">
                            <textarea name="text" class="form-control" rows="2" placeholder="回复 @{{ c.display_name }}"></textarea>
                          </div>
                          <div class="d-flex flex-column align-items-end">
                            <button class="btn btn-sm btn-primary" type="submit">回复</button>
                          </div>
                        </form>
                      </div>
                    </div>
                  {% endfor %}
                </div>
              {% else %}
                <div class="text-muted">还没有评论，快来抢沙发吧。</div>
              {% endif %}
            {% endwith %}

            {# 新评论（支持附件） #}
            <form action="{% url 'learning_logs:add_comment' entry.id %}" method="post" enctype="multipart/form-data" class="mt-2">
              {% csrf_token %}
              <div class="mb-2">
                <label class="form-label" for="text-{{ entry.id }}">评论内容</label>
                <textarea name="text" id="text-{{ entry.id }}" class="form-control" rows="3"></textarea>
              </div>
              <div class="form-check mb-2">
                <input class="form-check-input" type="checkbox" name="anonymous" id="anonymous-{{ entry.id }}">
                <label class="form-check-label" for="anonymous-{{ entry.id }}">匿名评论</label>
              </div>
              <div class="mb-2">
                <label class="form-label">附件（可选，可多选）</label>
                <input class="form-control" type="file" name="comment_attachments" multiple>
              </div>
              <div class="text-end">
                <button class="btn btn-outline-primary btn-sm" type="submit">发布评论</button>
              </div>
            </form>
          </div>
        {% endif %}

        {# 移除独立上传入口，附件仅在新建/编辑/评论时上传 #}

      </div>
    </div>
  {% empty %}
    <p>该日记本尚无日记。</p>
  {% endfor %}

{% endblock content %}

{% block extra_head %}
  <style>
    .ll-attachment-item:last-child{border-bottom:0}
    .ll-attach-icon{width:20px}
    .ll-folder-row{cursor:pointer; user-select:none;}
    .ll-folder-row.collapsed + .ll-folder-children{display:none;}
    .ll-caret-icon{width:12px; opacity:.7;}
    .ll-folder-row:hover{background:rgba(255,255,255,.05);}
    .ll-folder-children .ll-folder-children{margin-left:.5rem;}
  </style>
  {% load static %}
  {# 为避免 Manifest 模式下硬编码 /static 路径导致找不到哈希文件，这里预先解析所有可能用到的图标地址供前端使用 #}
  <script>
    window.LL_ICON_URLS = {
      folder: "{% static 'img/icons/folder.svg' %}",
      file_image: "{% static 'img/icons/file-image.svg' %}",
      file_play: "{% static 'img/icons/file-play.svg' %}",
      file_music: "{% static 'img/icons/file-music.svg' %}",
      file_text: "{% static 'img/icons/file-text.svg' %}",
      file_earmark: "{% static 'img/icons/file-earmark.svg' %}",
      caret_right: "{% static 'img/icons/caret-right.svg' %}",
      caret_down: "{% static 'img/icons/caret-down.svg' %}",
    };
  </script>
  <script src="{% static 'js/attachments.js' %}" defer></script>
{% endblock %}