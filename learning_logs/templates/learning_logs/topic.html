{% extends 'learning_logs/base.html' %}
{% load static %}

{% block page_back_button %}
  <a class="back-btn" href="{% url 'learning_logs:index' %}" aria-label="返回">
    <img src="{% static 'img/icons/arrow-left.svg' %}" alt="返回" />
  </a>
{% endblock %}

{% block page_header %}
  <div class="topic-header-glass d-flex justify-content-between align-items-center">
    <h1 class="mb-0 topic-title">{{ topic.text }}
      {% if topic.is_public %}
        <span class="badge text-bg-success align-middle" style="font-size: .45em;">公开</span>
      {% else %}
        <span class="badge text-bg-secondary align-middle" style="font-size: .45em;">私密</span>
      {% endif %}
    </h1>
    <div class="d-flex gap-2 flex-shrink-0 topic-actions">
      {% if topic.is_public or topic.owner == user %}
        <a href="{% url 'learning_logs:new_entry' topic.id %}" class="btn btn-primary">写一篇日记</a>
      {% endif %}
      {% if topic.owner == user %}
        <a href="{% url 'learning_logs:delete_topic' topic.text %}" class="btn btn-outline-danger">删除日记本</a>
      {% endif %}
    </div>
  </div>
{% endblock page_header %}

{% block content %}

  
  <div class="card mb-3">
    <div class="card-body">
      <h6 class="mb-2">日记本附件</h6>
      <div class="ll-attachments" data-parent-type="topic" data-parent-id="{{ topic.id }}"{% if user == topic.owner %} data-can-edit="1"{% endif %}>
        <div class="list-group list-group-flush ll-attach-list">
          {% include 'learning_logs/_attachment_tree.html' with tree=topic.attachment_tree parent_owner=topic.owner base='' allow_modify=True allow_download=True %}
        </div>
        {% if user == topic.owner %}
          <div class="mt-2 d-flex gap-2 flex-wrap">
            <label class="btn btn-outline-primary btn-sm mb-0">
              选择文件
              <input class="d-none" type="file" multiple>
            </label>
            <label class="btn btn-outline-primary btn-sm mb-0">
              选择文件夹
              <input class="d-none" type="file" multiple webkitdirectory directory>
            </label>
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  {% for entry in entries %}
    <div class="card mb-3">
      <h4 class="card-header d-flex justify-content-between align-items-center">
        <span class="entry-header">
          {% if entry.title %}
            <div class="entry-title fw-bold">{{ entry.title }}</div>
          {% else %}
            <div class="entry-title fw-bold text-muted">（无标题）</div>
          {% endif %}
          <div class="entry-meta small text-muted">发布于 {{ entry.date_added|date:'Y-m-d H:i' }}{% if entry.last_edited and entry.last_edited != entry.date_added %} · 最后编辑于 {{ entry.last_edited|date:'Y-m-d H:i' }}{% endif %}
            {% if entry.owner == user %}
              <a href="{% url 'learning_logs:edit_entry' entry.id %}" class="btn btn-sm btn-outline-primary ms-2">编辑日记</a>
            {% endif %}
          </div>
        </span>
        <span>
          {% if entry.is_public %}
            <span class="badge text-bg-success">公开</span>
          {% else %}
            <span class="badge text-bg-secondary">私密</span>
          {% endif %}
        </span>
      </h4>
      
      <div class="card-body">
        {{ entry.text|linebreaks }}

        
        {% with attachments=entry.attachment_set.all attachment_tree=entry.attachment_tree %}
          <hr>
          <h6 class="mb-2">附件</h6>
          <div class="ll-attachments" data-parent-type="entry" data-parent-id="{{ entry.id }}">
            <div class="list-group list-group-flush ll-attach-list">
              {% include 'learning_logs/_attachment_tree.html' with tree=attachment_tree parent_owner=entry.owner base='' allow_modify=False allow_download=True %}
            </div>
          </div>
        {% endwith %}

        {% if entry.is_public or entry.owner == user %}
          <hr>
          <h6 class="mb-2">评论</h6>
          <div class="mb-3 comment-area p-3">
            {% with top_comments=entry.top_comments %}
                {% if top_comments.exists %}
                  <div class="list-group list-group-flush">
                    {% for c in top_comments %}
                    <div class="list-group-item comment-item" data-id="{{ c.id }}">
                      <div class="d-flex justify-content-between align-items-center mb-1">
                        <div class="fw-semibold">{{ c.display_name }}</div>
                        <div class="small text-muted">{{ c.date_added|date:'Y-m-d H:i' }}</div>
                      </div>
                      {% if c.text %}
                        <div class="mb-1">{{ c.text|linebreaks }}</div>
                      {% endif %}
                      {% with tree=c.attachment_tree parent_owner=entry.owner %}
                        {% if tree.files or tree.dirs %}
                          <div class="mt-1">
                            <div class="ll-attachments" data-parent-type="comment" data-parent-id="{{ c.id }}" {% if c.allow_modify %}data-can-edit="1"{% endif %}>
                              <div class="list-group list-group-flush ll-attach-list">
                                {% include 'learning_logs/_attachment_tree.html' with tree=tree parent_owner=entry.owner base='' allow_modify=c.allow_modify allow_download=True %}
                              </div>
                            </div>
                          </div>
                        {% endif %}
                      {% endwith %}

                                      <div class="mt-2 d-flex gap-2">
                                        <a class="btn btn-sm btn-outline-secondary" href="{% url 'learning_logs:add_comment' entry.id %}?parent_id={{ c.id }}">回复</a>
                                        {% if c.user == user %}
                                          <button type="button" class="btn btn-sm btn-outline-danger delete-comment ms-2" data-id="{{ c.id }}">删除</button>
                                        {% endif %}
                                        {% if c.replies.exists %}
                                          <button type="button" class="btn btn-sm btn-link ms-auto btn-toggle-replies" data-target="#replies-{{ c.id }}">展开回复 ({{ c.replies.count }})</button>
                                        {% endif %}
                                      </div>

                      
                      {% if c.replies.exists %}
                        <div id="replies-{{ c.id }}" class="replies-container mt-2 ms-3">
                          <div class="list-group list-group-flush">
                            {% for r in c.replies.all %}
                              <div class="list-group-item reply-item">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                  <div class="fw-semibold">{{ r.display_name }}</div>
                                  <div class="small text-muted">{{ r.date_added|date:'Y-m-d H:i' }}</div>
                                </div>
                                {% if r.text %}
                                  <div class="mb-1">{{ r.text|linebreaks }}</div>
                                {% endif %}
                                {% if r.user == user %}
                                  <div class="mt-1 text-end">
                                    <button type="button" class="btn btn-sm btn-outline-danger delete-comment" data-id="{{ r.id }}">删除</button>
                                  </div>
                                {% endif %}
                                
                                {% if r.replies.exists %}
                                  <div class="small text-muted mt-1">
                                    {% for rr in r.replies.all %}
                                      <div>
                                        @{{ rr.display_name }}: {{ rr.text|truncatechars:120 }}
                                        {% if rr.user == user %}
                                          <button type="button" class="btn btn-sm btn-link text-danger delete-comment" data-id="{{ rr.id }}">删除</button>
                                        {% endif %}
                                      </div>
                                    {% endfor %}
                                  </div>
                                {% endif %}
                              </div>
                            {% endfor %}
                          </div>
                        </div>
                      {% endif %}

                      
                                      
                    </div>
                  {% endfor %}
                </div>
              {% else %}
                <div class="text-muted">还没有评论，快来抢沙发吧。</div>
              {% endif %}
            {% endwith %}

            
            <div class="text-end mt-2">
              <a class="btn btn-outline-primary btn-sm" href="{% url 'learning_logs:add_comment' entry.id %}">发表评论</a>
            </div>
          </div>
        {% endif %}

        

      </div>
    </div>
  {% empty %}
    <p>该日记本尚无日记。</p>
  {% endfor %}

{% endblock content %}

{% block extra_head %}{% endblock %}