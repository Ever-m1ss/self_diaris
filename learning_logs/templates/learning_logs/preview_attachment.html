{% extends "learning_logs/base.html" %}
{% load static %}

{% block page_back_button %}
  <a class="back-btn" href="{% url 'learning_logs:topic_by_user' topic.owner.username topic.text %}" aria-label="返回">
    <img src="{% static 'img/icons/arrow-left.svg' %}" alt="返回" />
  </a>
{% endblock %}

{% block page_header %}
  <h2>附件预览：{{ attachment.original_name }}</h2>
{% endblock page_header %}

{% block content %}
  {# 返回键已统一放在导航栏左侧，删除页面内的额外返回链接 #}
  <div class="card">
    <div class="card-body">
      {% if preview_type == 'text' %}
        <pre class="mb-0"><code class="hljs" style="white-space: pre-wrap; word-break: break-word;">{{ text|escape }}</code></pre>
      {% elif preview_type == 'image' %}
        <div class="text-center">
          <img src="{{ attachment.file.url }}" alt="{{ attachment.original_name }}" class="img-fluid" />
        </div>
      {% elif preview_type == 'video' %}
        <div class="text-center">
          <video controls class="w-100" preload="metadata">
            <source src="{{ attachment.file.url }}" type="{{ attachment.content_type }}">
            你的浏览器不支持视频播放。
          </video>
        </div>
      {% elif preview_type == 'audio' %}
        <div class="text-center">
          <audio controls>
            <source src="{{ attachment.file.url }}" type="{{ attachment.content_type }}">
            你的浏览器不支持音频播放。
          </audio>
        </div>
      {% else %}
        <div class="alert alert-secondary">该文件类型不支持在线预览。你可以点击“下载”按钮获取文件。</div>
      {% endif %}
    </div>
  </div>
  <p class="mt-3">
    原文件：<a href="{{ attachment.file.url }}" download>{{ attachment.original_name }}</a>
  </p>
{% endblock content %}

{% block extra_head %}
  {# 加载 highlight.js（只在预览页加载），使用 CDN 的 GitHub 主题并启用自动高亮 #}
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.8.0/styles/github.min.css">
  <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.8.0/lib/common.min.js" defer></script>
  <script defer>
    document.addEventListener('DOMContentLoaded', function(){
      try{
        if(window.hljs){
          // 自动检测语言并高亮
          document.querySelectorAll('pre code').forEach((el)=>{
            try{ hljs.highlightElement(el); }catch(e){}
          });
        }
      }catch(e){}
    });
  </script>
{% endblock %}
